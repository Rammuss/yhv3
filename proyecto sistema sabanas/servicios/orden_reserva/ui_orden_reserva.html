<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Reservas â€“ SalÃ³n</title>
<style>
  :root{
    --bg:#0f1220; --panel:#151935; --muted:#8fa0ff; --text:#e9ecff; --accent:#7aa2ff; --ok:#35d07f; --warn:#ffd166; --bad:#ff6b6b;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(120deg,#0e132b,#0b0f24 60%);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial}
  header{padding:16px 20px;border-bottom:1px solid rgba(255,255,255,.06);position:sticky;top:0;background:#0e132b;background:rgba(14,19,43,.8);backdrop-filter: blur(6px)}
  header h1{margin:0;font-size:18px;letter-spacing:.5px}
  .wrap{display:grid;grid-template-columns:320px 1fr;gap:16px;padding:16px}
  .card{background:var(--panel);border:1px solid rgba(255,255,255,.06);border-radius:14px;box-shadow:0 4px 16px rgba(8,10,20,.25);overflow:hidden}
  .card h3{margin:0;padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.06);font-size:14px;color:#cfe0ff;letter-spacing:.2px}
  .card .body{padding:12px 14px}
  label{display:block;margin:8px 0 4px;color:#cbd6ff;font-size:12px}
  input,select,button,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:#0f1430;color:var(--text);outline:none}
  input::placeholder{color:#8192d9}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:#0f1430;border:1px dashed rgba(255,255,255,.15);font-size:12px;color:#cbd6ff}
  .list{display:grid;gap:8px}
  .service{display:flex;align-items:center;justify-content:space-between;padding:8px;border:1px solid rgba(255,255,255,.12);border-radius:10px;background:#0f1430}
  .service small{opacity:.8}
  .muted{color:#a9b9ff}
  .actions{display:flex;gap:10px}
  .btn{cursor:pointer;background:var(--accent);border-color:transparent;color:#0a0e2a;font-weight:600}
  .btn.ghost{background:transparent;border-color:rgba(255,255,255,.2);color:#d9e2ff}
  .btn.ok{background:var(--ok)}
  .btn.bad{background:var(--bad)}
  .stack{display:grid;gap:10px}
  .grid-3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
  .grid-2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
  .slot{padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,.15);text-align:center;background:#0f1430;cursor:pointer}
  .slot.unavailable{opacity:.4;filter:grayscale(1);cursor:not-allowed}
  .slot.selected{outline:2px solid var(--accent)}
  .tag{font-size:11px;padding:3px 8px;border-radius:999px;background:#0f1430;border:1px solid rgba(255,255,255,.15);color:#cbd6ff}
  .tot{display:flex;align-items:center;justify-content:space-between;background:#0f1430;border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:10px}
  .kpi{display:flex;gap:10px;flex-wrap:wrap}
  .kpi .pill{background:#0f1430}
  .mini{font-size:12px;color:#9fb0ff}
  .table{width:100%;border-collapse:separate;border-spacing:0 8px}
  .table th{font-size:11px;color:#9fb0ff;font-weight:600;text-align:left;padding:0 8px}
  .rowx{background:#0f1430;border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:8px}
  .rowx + .rowx{margin-top:8px}
</style>
</head>
<body>
<header>
  <h1>ðŸ“… Orden de Reserva â€“ SalÃ³n (Clientes, Servicios, Profesionales, Calendario)</h1>
</header>
<div class="wrap">
  <!-- LADO IZQUIERDO: CLIENTE -->
  <section class="card">
    <h3>ðŸ‘¤ Cliente</h3>
    <div class="body stack">
      <div class="row">
        <input id="cliSearch" placeholder="Buscar por nombre o telÃ©fono" />
        <button class="btn ghost" id="btnBuscar">Buscar</button>
      </div>
      <div class="stack">
        <label>Nombre</label>
        <input id="cliNombre" placeholder="Ej: Cecilia LÃ³pez" />
        <label>TelÃ©fono</label>
        <input id="cliTel" placeholder="Ej: 0981 123 456" />
        <div class="actions">
          <button class="btn" id="btnGuardarCliente">Guardar cliente</button>
          <button class="btn ghost" id="btnNuevoCliente">Nuevo</button>
        </div>
        <small class="mini">Se guarda en LocalStorage (demo).</small>
      </div>
      <div class="kpi">
        <span class="pill">Clientes: <b id="kCli">0</b></span>
        <span class="pill">Reservas hoy: <b id="kHoy">0</b></span>
      </div>
    </div>
  </section>

  <!-- LADO DERECHO: RESERVA -->
  <section class="card">
    <h3>ðŸ§¾ Construir reserva</h3>
    <div class="body stack">

      <!-- CATEGORÃAS / SERVICIOS -->
      <div class="grid-3">
        <div class="stack">
          <div class="pill">ðŸ’‡ PeluquerÃ­a</div>
          <div id="listPeluqueria" class="list"></div>
        </div>
        <div class="stack">
          <div class="pill">ðŸ’… Manicura / Pedicura</div>
          <div id="listManos" class="list"></div>
        </div>
        <div class="stack">
          <div class="pill">ðŸŽ¨ Estilista (color)</div>
          <div id="listEstilista" class="list"></div>
        </div>
      </div>

      <!-- CARRITO SERVICIOS SELECCIONADOS -->
      <div class="stack">
        <div class="pill">ðŸ§º Servicios seleccionados</div>
        <div id="carrito" class="list"></div>
        <div class="tot"><span>Total (Gs)</span><b id="totalGs">0</b></div>
      </div>

      <!-- PROFESIONAL Y FECHA/HORA -->
      <div class="grid-2">
        <div class="stack">
          <label>Profesional</label>
          <select id="selPro"></select>
          <small class="mini">Se filtra por especialidad en base a los servicios elegidos.</small>
        </div>
        <div class="stack">
          <label>Estado</label>
          <select id="selEstado">
            <option>Pendiente</option>
            <option>Confirmada</option>
            <option>Cancelada</option>
          </select>
        </div>
      </div>

      <div class="grid-2">
        <div class="stack">
          <label>Fecha</label>
          <input type="date" id="fecha" />
        </div>
        <div class="stack">
          <label>Hora (sugerencias segÃºn disponibilidad)</label>
          <div id="slots" class="grid-3"></div>
        </div>
      </div>

      <div class="actions">
        <button class="btn" id="btnSugerir">Ver turnos libres</button>
        <button class="btn ok" id="btnReservar">Guardar reserva</button>
        <button class="btn bad" id="btnLimpiar">Limpiar</button>
      </div>

      <div class="pill">ðŸ”¢ NÂº de Orden sugerido: <b id="ordSug">â€”</b></div>

    </div>
  </section>
</div>

<!-- LISTADO DE RESERVAS -->
<div class="wrap" style="padding-top:0">
  <section class="card" style="grid-column:1/-1">
    <h3>ðŸ“š Reservas</h3>
    <div class="body">
      <table class="table" id="tablaHead">
        <thead>
          <tr>
            <th>Orden</th><th>Fecha</th><th>Hora</th><th>Cliente</th><th>Profesional</th><th>Servicios</th><th>Total</th><th>Estado</th>
          </tr>
        </thead>
      </table>
      <div id="reservas" class="list"></div>
    </div>
  </section>
</div>

<script>
// ---------------- DEMO DATA ----------------
const servicios = {
  peluqueria: [
    {id:'pel-corte', nombre:'Corte', precio: 70000, durMin: 30},
    {id:'pel-lavado', nombre:'Lavado', precio: 30000, durMin: 20},
    {id:'pel-peinado', nombre:'Peinado', precio: 80000, durMin: 40},
    {id:'pel-tratamiento', nombre:'Tratamiento', precio: 120000, durMin: 45},
    {id:'pel-alisado', nombre:'Alisado', precio: 250000, durMin: 90},
  ],
  manos: [
    {id:'man-semi', nombre:'Esmaltado Semi', precio: 90000, durMin: 50},
    {id:'man-acrilico', nombre:'AcrÃ­lico', precio: 150000, durMin: 80},
    {id:'man-trad', nombre:'Esmaltado Tradicional', precio: 60000, durMin: 40},
    {id:'man-pedicura', nombre:'Pedicura', precio: 110000, durMin: 60},
  ],
  estilista: [
    {id:'est-balayage', nombre:'Balayage', precio: 420000, durMin: 120},
    {id:'est-morena', nombre:'Morena iluminada', precio: 380000, durMin: 110},
    {id:'est-luces', nombre:'Luces', precio: 300000, durMin: 100},
    {id:'est-color', nombre:'ColoraciÃ³n completa', precio: 260000, durMin: 90},
  ],
};

const profesionales = [
  {id:'pro-esteban', nombre:'Esteban', especialidades:['peluqueria','estilista']},
  {id:'pro-cecilia', nombre:'Cecilia', especialidades:['peluqueria','manos']},
  {id:'pro-luisa', nombre:'Luisa', especialidades:['manos']},
  {id:'pro-ramiro', nombre:'Ramiro', especialidades:['estilista']},
];

// Horario base 09:00â€“18:00, intervalos de 30 min
const HORAINI = 9, HORAFIN = 18, STEP = 30; // minutos

// ---------------- STATE ----------------
const LS = {
  clientes: 'demo_clientes_v1',
  reservas: 'demo_reservas_v1',
  contador: 'demo_contador_orden_v1'
};

let clientes = JSON.parse(localStorage.getItem(LS.clientes)||'[]');
let reservas = JSON.parse(localStorage.getItem(LS.reservas)||'[]');
let contador = parseInt(localStorage.getItem(LS.contador)||'1',10);

// ---------------- HELPERS ----------------
const $ = sel => document.querySelector(sel);
function money(n){return (n||0).toLocaleString('es-PY');}
function hoyISO(){const d=new Date(); d.setHours(0,0,0,0); return d.toISOString().slice(0,10)}
function addMinutes(date,min){return new Date(date.getTime()+min*60000)}
function toTimeStr(d){return d.toTimeString().slice(0,5)}
function parseHM(hm){const [h,m]=hm.split(':').map(Number); const d=new Date(); d.setHours(h,m,0,0); return d}
function overlap(aStart,aEnd,bStart,bEnd){return aStart < bEnd && bStart < aEnd}
function nextOrden(){const ymd = (new Date()).toISOString().slice(0,10).replaceAll('-','');return `OR-${ymd}-${String(contador).padStart(4,'0')}`}

// ---------------- RENDER SERVICIOS ----------------
function renderServicios(){
  const mount = (arr, contId) => {
    const cont = document.getElementById(contId);
    cont.innerHTML = '';
    arr.forEach(s => {
      const el = document.createElement('div'); el.className='service';
      el.innerHTML = `
        <div>
          <div><b>${s.nombre}</b></div>
          <small>${s.durMin} min Â· Gs ${money(s.precio)}</small>
        </div>
        <div class="actions">
          <button class="btn" data-add="${s.id}">Agregar</button>
        </div>`;
      cont.appendChild(el);
    });
  };
  mount(servicios.peluqueria,'listPeluqueria');
  mount(servicios.manos,'listManos');
  mount(servicios.estilista,'listEstilista');
}

const carrito = new Map(); // idServicio -> {servicio, qty}
function addServicio(id){
  const s = findServicio(id); if(!s) return;
  const it = carrito.get(id)||{servicio:s, qty:0}; it.qty++; carrito.set(id,it);
  renderCarrito(); filterProfesionales();
}
function removeServicio(id){
  const it = carrito.get(id); if(!it) return; it.qty--; if(it.qty<=0) carrito.delete(id);
  renderCarrito(); filterProfesionales();
}
function findServicio(id){ for(const k of Object.keys(servicios)){ const f=servicios[k].find(x=>x.id===id); if(f) return {...f, categoria:k}; } return null; }
function sumDur(){ let m=0; for(const it of carrito.values()){ m += it.servicio.durMin * it.qty; } return m; }
function sumTotal(){ let t=0; for(const it of carrito.values()){ t += it.servicio.precio * it.qty; } return t; }

function renderCarrito(){
  const cont = document.getElementById('carrito'); cont.innerHTML = '';
  if(carrito.size===0){cont.innerHTML = '<div class="mini">Sin servicios aÃºn.</div>';}
  for(const [id,it] of carrito){
    const row = document.createElement('div'); row.className='service';
    row.innerHTML = `
      <div>
        <div><b>${it.servicio.nombre}</b> <span class="tag">${it.servicio.categoria}</span></div>
        <small>${it.qty} Ã— Gs ${money(it.servicio.precio)} Â· ${it.servicio.durMin} min</small>
      </div>
      <div class="actions">
        <button class="btn ghost" data-min="${id}">â€“</button>
        <button class="btn" data-plus="${id}">+</button>
      </div>`;
    cont.appendChild(row);
  }
  document.getElementById('totalGs').textContent = money(sumTotal());
  document.getElementById('ordSug').textContent = nextOrden();
}

// ---------------- PROFESIONALES ----------------
function filterProfesionales(){
  const cats = new Set([...carrito.values()].map(x=>x.servicio.categoria));
  const options = profesionales.filter(p=> cats.size===0 || [...cats].every(c => p.especialidades.includes(c)) );
  const sel = document.getElementById('selPro'); sel.innerHTML='';
  if(options.length===0){ sel.innerHTML = '<option value="">â€” Sin coincidencias â€”</option>'; return; }
  options.forEach(p=>{ const o=document.createElement('option'); o.value=p.id; o.textContent=p.nombre; sel.appendChild(o); });
}

// ---------------- CLIENTES ----------------
function upKpis(){
  document.getElementById('kCli').textContent = clientes.length;
  const hoy = hoyISO();
  const countHoy = reservas.filter(r=>r.fecha===hoy).length;
  document.getElementById('kHoy').textContent = countHoy;
}
function guardarCliente(){
  const nombre = document.getElementById('cliNombre').value.trim();
  const tel = document.getElementById('cliTel').value.trim();
  if(!nombre||!tel){alert('CompletÃ¡ nombre y telÃ©fono.');return;}
  const existe = clientes.find(c=> c.tel===tel || c.nombre.toLowerCase()===nombre.toLowerCase());
  if(existe){ // actualizar
    existe.nombre = nombre; existe.tel = tel;
  }else{
    clientes.push({id:'cli-'+Date.now(),nombre,tel});
  }
  localStorage.setItem(LS.clientes,JSON.stringify(clientes));
  upKpis();
  alert('Cliente guardado.');
}
function buscarCliente(){
  const q = document.getElementById('cliSearch').value.trim().toLowerCase();
  if(!q) return;
  const c = clientes.find(x=> x.nombre.toLowerCase().includes(q) || (x.tel||'').toLowerCase().includes(q));
  if(c){ document.getElementById('cliNombre').value=c.nombre; document.getElementById('cliTel').value=c.tel; }
  else alert('No encontrado.');
}
function nuevoCliente(){ document.getElementById('cliNombre').value=''; document.getElementById('cliTel').value=''; }

// ---------------- DISPONIBILIDAD ----------------
function generarSlots(fecha, duracionMin, proId){
  const slots = [];
  if(!fecha) return slots;
  for(let h=HORAINI; h<HORAFIN; h++){
    for(let m=0; m<60; m+=STEP){
      const from = new Date(`${fecha}T${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:00`);
      const to = addMinutes(from, duracionMin || 30);
      const ok = libre(proId, from, to);
      slots.push({hm: toTimeStr(from), ok});
    }
  }
  return slots;
}
function libre(proId, from, to){
  const samePro = reservas.filter(r=> r.proId===proId && r.fecha===from.toISOString().slice(0,10));
  for(const r of samePro){
    const aStart = parseHM(r.hora);
    const aEnd = addMinutes(aStart, r.duracion);
    if(overlap(from,to,aStart,aEnd)) return false;
  }
  return true;
}

function renderSlots(){
  const fecha = document.getElementById('fecha').value || hoyISO();
  const proId = document.getElementById('selPro').value || profesionales[0]?.id;
  const dur = sumDur() || 30;
  const slots = generarSlots(fecha, dur, proId);
  const cont = document.getElementById('slots'); cont.innerHTML='';
  slots.forEach(s=>{
    const el = document.createElement('div'); el.className = 'slot' + (s.ok?'':' unavailable');
    el.textContent = s.hm; el.dataset.hm=s.hm; el.onclick = () => {
      if(!s.ok) return; document.querySelectorAll('.slot.selected').forEach(x=>x.classList.remove('selected')); el.classList.add('selected');
    };
    cont.appendChild(el);
  });
}

// ---------------- RESERVAR ----------------
function guardarReserva(){
  const nombre = document.getElementById('cliNombre').value.trim();
  const tel = document.getElementById('cliTel').value.trim();
  if(!nombre||!tel){alert('CargÃ¡ el cliente.');return;}
  if(carrito.size===0){alert('AgregÃ¡ al menos un servicio.');return;}
  const proId = document.getElementById('selPro').value; if(!proId){alert('ElegÃ­ profesional.');return;}
  const slotSel = document.querySelector('.slot.selected'); if(!slotSel){alert('ElegÃ­ una hora disponible.');return;}
  const fecha = document.getElementById('fecha').value || hoyISO();
  const hora = slotSel.dataset.hm;
  const duracion = sumDur();
  const orden = nextOrden();
  const estado = document.getElementById('selEstado').value;
  const items = [...carrito.values()].map(it=>({id:it.servicio.id,nombre:it.servicio.nombre,precio:it.servicio.precio,qty:it.qty,categoria:it.servicio.categoria,durMin:it.servicio.durMin}));
  const total = sumTotal();

  // Doble chequeo de solapamiento
  const start = parseHM(hora); const end = addMinutes(start,duracion);
  if(!libre(proId, start, end)){ alert('Ese turno se ocupÃ³ reciÃ©n. ElegÃ­ otro.'); renderSlots(); return; }

  reservas.push({orden,fecha,hora,cliente:{nombre,tel},proId,proNombre: (profesionales.find(p=>p.id===proId)||{}).nombre,items,total,estado,duracion});
  localStorage.setItem(LS.reservas,JSON.stringify(reservas));
  contador++; localStorage.setItem(LS.contador,String(contador));
  renderReservas(); renderSlots(); upKpis();
  alert('Reserva guardada. NÂº '+orden);
}

function renderReservas(){
  const cont = document.getElementById('reservas'); cont.innerHTML='';
  if(reservas.length===0){ cont.innerHTML='<div class="mini">AÃºn no hay reservas.</div>'; return; }
  // Ordenar por fecha/hora descendente
  const copy = [...reservas].sort((a,b)=> (b.fecha.localeCompare(a.fecha)) || (b.hora.localeCompare(a.hora)) );
  copy.forEach(r=>{
    const row = document.createElement('div'); row.className='rowx';
    const serviciosTxt = r.items.map(i=> `${i.qty}Ã— ${i.nombre}`).join(', ');
    row.innerHTML = `
      <div style="display:grid;grid-template-columns:110px 80px 130px 120px 1fr 90px 100px;gap:8px;align-items:center">
        <div><b>${r.orden}</b></div>
        <div>${r.fecha}</div>
        <div>${r.hora} (${r.duracion}m)</div>
        <div>${r.cliente.nombre}</div>
        <div>${r.proNombre}</div>
        <div class="muted">${serviciosTxt}</div>
        <div><b>Gs ${money(r.total)}</b></div>
        <div><span class="tag">${r.estado}</span></div>
      </div>`;
    cont.appendChild(row);
  });
}

function limpiar(){ carrito.clear(); renderCarrito(); filterProfesionales(); renderSlots(); document.querySelectorAll('.slot.selected').forEach(x=>x.classList.remove('selected')); }

// ---------------- EVENTS ----------------
function wire(){
  document.getElementById('btnGuardarCliente').onclick = guardarCliente;
  document.getElementById('btnBuscar').onclick = buscarCliente;
  document.getElementById('btnNuevoCliente').onclick = nuevoCliente;
  document.getElementById('btnSugerir').onclick = renderSlots;
  document.getElementById('btnReservar').onclick = guardarReserva;
  document.getElementById('btnLimpiar').onclick = limpiar;
  document.getElementById('fecha').value = hoyISO();
  document.body.addEventListener('click', (e)=>{
    const add = e.target.getAttribute('data-add'); if(add){ addServicio(add); return; }
    const plus = e.target.getAttribute('data-plus'); if(plus){ addServicio(plus); return; }
    const min = e.target.getAttribute('data-min'); if(min){ removeServicio(min); return; }
  });
}

// ---------------- INIT ----------------
renderServicios(); renderCarrito(); filterProfesionales(); renderReservas(); upKpis(); wire(); renderSlots();
</script>
</body>
</html>
