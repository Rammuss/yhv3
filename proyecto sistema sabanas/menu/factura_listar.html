<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Facturas de Compra</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    body{font-family:Arial, sans-serif; background:#f7f7f7; margin:20px}
    .wrap{max-width:1100px; margin:auto}
    h1{margin:0 0 12px}
    .row{display:flex; gap:10px; align-items:center; margin-bottom:12px; flex-wrap:wrap}
    table{width:100%; border-collapse:collapse}
    th,td{border:1px solid #eaeaea; padding:8px; text-align:left}
    th{background:#fafafa}
    .right{text-align:right}
    .btn{padding:6px 10px; border:1px solid #ddd; background:#fff; cursor:pointer; border-radius:6px}
    .btn:hover{background:#f3f3f3}
  </style>
</head>
<body>
  <div id="navbar-container"></div>
  <div class="wrap">
    <h1>Facturas de Compra</h1>

    <div class="row">
      <label>Proveedor:</label>
      <select id="proveedor"></select>
      <label>Estado:</label>
      <select id="estado">
        <option value="">Todos</option>
        <option>Registrada</option>
        <option>Anulada</option>
      </select>
      <label>Desde:</label>
      <input type="date" id="desde">
      <label>Hasta:</label>
      <input type="date" id="hasta">
      <button class="btn" id="btnBuscar">Buscar</button>
    </div>

    <table id="tabla">
      <thead>
        <tr>
          <th>#Factura</th>
          <th>Proveedor</th>
          <th>Fecha</th>
          <th>Nº Doc</th>
          <th>Timbrado</th><!-- NUEVO -->
          <th>Estado</th>
          <th>Condición</th>
          <th class="right">Total</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const RUTAS = {
      proveedores: 'proveedores_options.php',
      listar:      'factura_listar.php',
      anular:      'factura_anular.php',
      ver:         '../menu/factura_ver.php' // ajustá si cambia la ruta real
    };

    const $ = s => document.querySelector(s);

    document.addEventListener('DOMContentLoaded', ()=>{
      cargarProveedores();
      $('#btnBuscar').addEventListener('click', buscar);
      buscar();
    });

    async function cargarProveedores(){
      try{
        const r = await fetch(RUTAS.proveedores);
        const data = await r.json();
        const sel = $('#proveedor');
        sel.innerHTML = '<option value="">Todos</option>';
        (data||[]).forEach(p=>{
          const o = document.createElement('option');
          o.value = p.id_proveedor;
          o.textContent = p.nombre;
          sel.appendChild(o);
        });
      }catch(e){ console.error(e); }
    }

    async function buscar(){
      const qp = new URLSearchParams();
      const prov = $('#proveedor').value;
      const est  = $('#estado').value;
      const d    = $('#desde').value;
      const h    = $('#hasta').value;
      if (prov) qp.set('id_proveedor', prov);
      if (est)  qp.set('estado', est);
      if (d)    qp.set('desde', d);
      if (h)    qp.set('hasta', h);

      try{
        const r = await fetch(RUTAS.listar + (qp.toString() ? '?'+qp.toString() : ''));
        const j = await r.json();
        if (!j.ok) throw new Error(j.error||'Error');
        render(j.data||[]);
      }catch(e){
        console.error(e);
        alert('Error listando facturas');
      }
    }

    function render(rows){
      const tb = $('#tabla tbody');
      tb.innerHTML = '';
      if ((rows||[]).length===0){
        tb.innerHTML = '<tr><td colspan="9" class="right">Sin resultados</td></tr>'; // 9 columnas ahora
        return;
      }
      rows.forEach(f=>{
        const condicionTxt = (f.condicion||'') === 'CREDITO'
          ? `CREDITO · ${f.cuotas||1} cuota(s)`
          : (f.condicion||'CONTADO');

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${f.id_factura}</td>
          <td>${esc(f.proveedor)||f.id_proveedor}</td>
          <td>${f.fecha_emision||''}</td>
          <td>${esc(f.numero_documento)||''}</td>
          <td>${esc(f.timbrado_numero||'')}</td> <!-- NUEVO -->
          <td>${esc(f.estado)||''}</td>
          <td>${esc(condicionTxt)}</td>
          <td class="right">${fmt(f.total_factura)}</td>
          <td>
            <button class="btn" onclick="verFactura(${f.id_factura})">Ver</button>
            ${
              (f.estado==='Anulada')
              ? '<span style="color:#888;margin-left:6px">—</span>'
              : `<button class="btn" style="margin-left:6px" onclick="anular(${f.id_factura})">Anular</button>`
            }
          </td>
        `;
        tb.appendChild(tr);
      });
    }

    async function verFactura(id_factura){
      try{
        const r = await fetch(`${RUTAS.ver}?id_factura=${encodeURIComponent(id_factura)}`);
        const j = await r.json();
        if (!j.ok) throw new Error(j.error||'No se pudo obtener la factura');

        const f = j.cabecera||{};
        const items = j.detalles||[];
        const t = j.totales||{};

        // Sucursal
        const sucTxt = f.sucursal_nombre ? f.sucursal_nombre : (f.id_sucursal ? ('ID '+f.id_sucursal) : '—');
        // Condición + cuotas
        const condicionTxt = (f.condicion||'') === 'CREDITO'
          ? `CREDITO · ${f.cuotas||1} cuota(s)`
          : (f.condicion||'CONTADO');
        // Plazos (solo si es crédito)
        const plazoTxt = (f.condicion==='CREDITO')
          ? `1ra: ${f.dias_plazo ?? 0} día(s) • Intervalo: ${f.intervalo_dias ?? 0} día(s)`
          : '—';
        // Moneda
        const monedaTxt = f.moneda || 'PYG';
        // Timbrado
        const timbradoTxt = f.timbrado_numero ? f.timbrado_numero : '—';

        const rowsHtml = items.map((it,i)=>{
          const ivaLabel = (it.iva===0 || it.iva==='0') ? 'Exento' : `${it.iva}%`;
          return `
            <tr>
              <td>${i+1}</td>
              <td>${esc(it.producto||'')}</td>
              <td class="right">${Number(it.cantidad)}</td>
              <td class="right">${fmt(it.precio_unitario)}</td>
              <td class="right">${ivaLabel}</td>
              <td class="right">${fmt(it.total_linea)}</td>
            </tr>
          `;
        }).join('');

        const html = `
          <div class="grid">
            <div>
              <div><strong># Factura:</strong> ${f.id_factura}</div>
              <div><strong>Nº Doc:</strong> ${esc(f.numero_documento||'')}</div>
              <div><strong>Timbrado:</strong> ${esc(timbradoTxt)}</div> <!-- NUEVO -->
              <div><strong>Fecha:</strong> ${esc(f.fecha_emision||'')}</div>
              <div><strong>Estado:</strong> ${esc(f.estado||'')}</div>
              <div><strong>Moneda:</strong> ${esc(monedaTxt)}</div>
              <div><strong>Condición:</strong> ${esc(condicionTxt)}</div>
              <div><strong>Plazos:</strong> ${esc(plazoTxt)}</div>
            </div>
            <div>
              <div><strong>Proveedor:</strong> ${esc(f.proveedor||'')}</div>
              <div><strong>RUC:</strong> ${esc(f.ruc||'')}</div>
              <div><strong>Teléfono:</strong> ${esc(f.telefono||'')}</div>
              <div><strong>Sucursal:</strong> ${esc(sucTxt)}</div>
            </div>
          </div>

          ${f.observacion ? `<p class="muted" style="margin-top:8px"><strong>Obs.:</strong> ${esc(f.observacion)}</p>` : ''}

          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Producto</th>
                <th class="right">Cant.</th>
                <th class="right">P. Unit.</th>
                <th class="right">IVA</th>
                <th class="right">Total</th>
              </tr>
            </thead>
            <tbody>${rowsHtml || `<tr><td colspan="6" class="right muted">Sin ítems</td></tr>`}</tbody>
            <tfoot>
              <tr><td colspan="5" class="right">Subtotal</td><td class="right">${fmt(t.subtotal)}</td></tr>
              ${t.iva10!=null ? `<tr><td colspan="5" class="right">IVA 10%</td><td class="right">${fmt(t.iva10)}</td></tr>` : ''}
              ${t.iva5!=null  ? `<tr><td colspan="5" class="right">IVA 5%</td><td class="right">${fmt(t.iva5)}</td></tr>`   : ''}
              ${t.iva_exenta!=null ? `<tr><td colspan="5" class="right">Exentas</td><td class="right">${fmt(t.iva_exenta)}</td></tr>` : ''}
              <tr><td colspan="5" class="right">Total</td><td class="right">${fmt(t.total)}</td></tr>
            </tfoot>
          </table>

          <div class="actions" style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px">
            <button class="btn" onclick="imprimirFactura()">Imprimir</button>
          </div>
        `;
        $('#ver-content').innerHTML = html;
        abrirVer();
      }catch(e){
        alert(e.message||'Error al cargar la factura');
      }
    }

    function abrirVer(){ $('#ver-backdrop').style.display = 'flex'; }
    function cerrarVer(){ $('#ver-backdrop').style.display = 'none'; }

    function imprimirFactura(){
      const w = window.open('', '_blank');
      if(!w){ alert('Desbloqueá los popups para imprimir.'); return; }
      w.document.write(`
        <html><head><title>Factura</title>
        <meta charset="utf-8"/>
        <style>
          body{font-family:Arial, sans-serif; padding:16px}
          table{width:100%; border-collapse:collapse}
          th,td{border:1px solid #ccc; padding:6px}
          .right{text-align:right}
          tfoot td{font-weight:bold}
        </style>
        </head><body>${$('#ver-content').innerHTML}</body></html>
      `);
      w.document.close();
      w.focus();
      w.print();
    }

    async function anular(id_factura){
      if(!confirm(`¿Anular factura #${id_factura}?`)) return;
      const motivo = prompt('Motivo (opcional):') || '';
      const fd = new FormData();
      fd.append('id_factura', id_factura);
      fd.append('motivo', motivo);
      try{
        const r = await fetch(RUTAS.anular, {method:'POST', body: fd});
        const j = await r.json();
        if(!r.ok || !j.ok) throw new Error(j.error||'No se pudo anular');
        alert(j.msg||'Factura anulada');
        buscar();
      }catch(e){ alert(e.message||'Error'); }
    }

    function fmt(n){ return Number(n||0).toLocaleString('es-PY',{minimumFractionDigits:2, maximumFractionDigits:2}); }
    function esc(s){ return String(s||'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }

    // Exponer para inline handlers
    window.anular = anular;
    window.verFactura = verFactura;
  </script>
  <script src="navbar.js"></script>

  <style>
    /* Modal simple */
    .modal-backdrop{position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:9999}
    .modal{background:#fff; width:min(1000px,95vw); max-height:90vh; overflow:auto; border-radius:10px; box-shadow:0 10px 30px rgba(0,0,0,.2)}
    .modal header{display:flex; justify-content:space-between; align-items:center; padding:12px 16px; border-bottom:1px solid #eee}
    .modal header h3{margin:0}
    .modal .content{padding:16px}
    .modal .grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .modal .muted{color:#666; font-size:13px}
    .modal .right{text-align:right}
    .modal .btn-close{border:0; background:#eee; padding:6px 10px; border-radius:6px; cursor:pointer}
    .modal table{width:100%; border-collapse:collapse; margin-top:8px}
    .modal th,.modal td{border:1px solid #eee; padding:8px; text-align:left}
    .modal tfoot td{font-weight:bold}
    .modal .actions{display:flex; gap:8px; justify-content:flex-end; margin-top:12px}
    .modal .btn{padding:6px 10px; border:1px solid #ddd; background:#fff; cursor:pointer; border-radius:6px}
    .modal .btn:hover{background:#f3f3f3}
    @media (max-width:700px){ .modal .grid{grid-template-columns:1fr} }
  </style>

  <div id="ver-backdrop" class="modal-backdrop">
    <div class="modal">
      <header>
        <h3>Factura de Compra</h3>
        <button class="btn-close" onclick="cerrarVer()">Cerrar</button>
      </header>
      <div class="content" id="ver-content"><!-- se inyecta --></div>
    </div>
  </div>
</body>
</html>
