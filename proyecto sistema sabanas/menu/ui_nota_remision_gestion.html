<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Notas de Remisión - Gestión</title>
  <link rel="stylesheet" href="/../TALLER DE ANALISIS Y PROGRAMACIÓN I/proyecto sistema sabanas/menu/styles.css">
  <style>
    body{font-family:Arial, sans-serif; background:#f7f7f7; margin:20px}
    .wrap{max-width:1150px; margin:auto}
    h1{margin:0 0 12px}
    .row{display:flex; gap:10px; align-items:center; margin-bottom:12px; flex-wrap:wrap}
    select,input,button{padding:8px}
    table{width:100%; border-collapse:collapse}
    th,td{border:1px solid #eaeaea; padding:8px; text-align:left}
    th{background:#fafafa}
    .right{text-align:right}
    .btn{padding:6px 10px; border:1px solid #ddd; background:#fff; cursor:pointer; border-radius:6px}
    .btn:hover{background:#f3f3f3}
    .muted{color:#777}
    .pill{display:inline-block;padding:2px 8px;border-radius:12px;border:1px solid #ddd;font-size:12px}
    .pill.ok{background:#eafaf0; border-color:#2ecc71}
    .pill.bad{background:#fdecea; border-color:#e74c3c}
    .pagination{display:flex; gap:6px; align-items:center}
    .modal{position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:9998}
    .modal .card{background:#fff; width:min(780px, 95vw); max-height:80vh; overflow:auto; border-radius:8px; padding:16px; box-shadow:0 8px 24px rgba(0,0,0,.25)}
    .modal h3{margin:0 0 10px}
    .actions{display:flex; gap:6px}
  </style>
</head>
<body>
    <div id="navbar-container"></div>

  <div class="wrap">
    <h1>Notas de Remisión</h1>

    <div class="row">
      <label>Desde:</label><input type="date" id="f_desde">
      <label>Hasta:</label><input type="date" id="f_hasta">
      <label>Proveedor:</label><select id="id_proveedor"></select>
      <label>Sucursal:</label><select id="id_sucursal"></select>
      <label>Estado:</label>
      <select id="estado">
        <option value="">Todos</option>
        <option>Activo</option>
        <option>Anulada</option>
      </select>
      <input type="text" id="q" placeholder="ID nota / Nº remisión / Nº factura" style="width:240px">
      <button class="btn" id="btnBuscar">Buscar</button>
      <span id="resumen" class="muted"></span>
    </div>

    <table id="tabla">
      <thead>
        <tr>
          <th>ID</th>
          <th>Fecha</th>
          <th>Proveedor</th>
          <th>Sucursal</th>
          <th>Nº Factura</th>
          <th class="right">Total</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="row" style="justify-content:space-between">
      <div class="muted" id="meta"></div>
      <div class="pagination">
        <button class="btn" id="prev">&lt;</button>
        <span id="pageInfo" class="muted"></span>
        <button class="btn" id="next">&gt;</button>
      </div>
    </div>
  </div>

  <!-- Modal Detalle -->
  <div id="modal" class="modal" aria-hidden="true">
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center">
        <h3 id="m_titulo">Detalle</h3>
        <button class="btn" onclick="closeModal()">Cerrar</button>
      </div>
      <div id="m_cab" class="muted" style="margin-bottom:8px"></div>
      <table>
        <thead>
          <tr>
            <th>ID Fact Det</th>
            <th>ID Producto</th>
            <th>Producto</th>
            <th class="right">Cantidad</th>
          </tr>
        </thead>
        <tbody id="m_det"></tbody>
      </table>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    const RUTAS = {
      proveedores: 'proveedores_options.php',
      sucursales:  '../menu/referenciales_compra/sucursales/sucursales_options.php?estado=ACTIVO',
      listar:      'nota_remision_listar.php',
      detalle:     'nota_remision_detalle.php',
      anular:      'nota_remision_anular.php',
      pdf:         'nota_remision_pdf.php' // opcional, si lo generás
    };

    const $ = s => document.querySelector(s);
    let page = 1, pages = 1, limit = 20;

    document.addEventListener('DOMContentLoaded', async ()=>{
      // fechas por defecto: últimos 30 días
      const hoy = new Date(); const d30 = new Date(hoy); d30.setDate(hoy.getDate()-30);
      $('#f_desde').value = d30.toISOString().slice(0,10);
      $('#f_hasta').value = hoy.toISOString().slice(0,10);

      await cargarProveedores();
      await cargarSucursales();

      // listeners
      $('#btnBuscar').addEventListener('click', ()=>{ page=1; buscar(false); });
      $('#prev').addEventListener('click', ()=>{ if(page>1){ page--; buscar(false); }});
      $('#next').addEventListener('click', ()=>{ if(page<pages){ page++; buscar(false); }});

      $('#toast').addEventListener('click', ()=> hideToast());
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ hideToast(); closeModal(); }});

      // primer load silencioso (sin toast)
      buscar(true);
    });

    async function cargarProveedores(){
      try{
        const r = await fetch(RUTAS.proveedores);
        const data = await r.json();
        const sel = $('#id_proveedor');
        sel.innerHTML = '<option value="">Todos</option>';
        (data||[]).forEach(p=>{
          const o = document.createElement('option');
          o.value = p.id_proveedor; o.textContent = p.nombre;
          sel.appendChild(o);
        });
      }catch(e){ if(false) showToast('Error cargando proveedores','is-error'); }
    }
    async function cargarSucursales(){
      try{
        const r = await fetch(RUTAS.sucursales);
        const data = await r.json();
        const sel = $('#id_sucursal');
        sel.innerHTML = '<option value="">Todas</option>';
        (data||[]).forEach(s=>{
          const o = document.createElement('option');
          o.value = s.id_sucursal; o.textContent = s.nombre;
          sel.appendChild(o);
        });
      }catch(e){ if(false) showToast('Error cargando sucursales','is-error'); }
    }

    // AHORA acepta 'silent' (true = no mostrar toast)
    async function buscar(silent = false){
      const fd = $('#f_desde').value;
      const fh = $('#f_hasta').value;
      if(fd && fh && fd>fh){ if(!silent) showToast('Rango de fechas inválido','is-error'); return; }

      const params = new URLSearchParams({
        page, limit,
        fecha_desde: fd || '',
        fecha_hasta: fh || '',
        id_proveedor: $('#id_proveedor').value || 0,
        id_sucursal: $('#id_sucursal').value || 0,
        estado: $('#estado').value || '',
        q: $('#q').value.trim() || ''
      });

      try{
        const r = await fetch(`${RUTAS.listar}?`+params.toString());
        const j = await r.json();
        if(!j.ok) throw new Error(j.error||'Error');
        renderTabla(j.data||[]);
        pages = j.meta?.pages || 1;
        page = Math.min(Math.max(1,page), pages);
        $('#pageInfo').textContent = `Página ${page} de ${pages}`;
        $('#meta').textContent = `Total: ${j.meta?.total||0} — Remitido: ${fmt(j.meta?.sum_total_remitido||0)}`;
        $('#resumen').textContent = `${(j.data||[]).length} resultado(s) en esta página`;
        if(!silent) showToast('Listado actualizado','ok');
      }catch(e){
        console.error(e);
        if(!silent) showToast('Error al listar','is-error');
      }
    }

    function renderTabla(rows){
      const tb = $('#tabla tbody');
      tb.innerHTML = '';
      rows.forEach(r=>{
        const tr = document.createElement('tr');
        const pill = r.estado==='Activo' ? '<span class="pill ok">Activo</span>' : '<span class="pill bad">Anulada</span>';
        tr.innerHTML = `
          <td>${r.id_nota_remision}</td>
          <td>${r.fecha_remision||''}</td>
          <td>${esc(r.proveedor||'')}</td>
          <td>${esc(r.sucursal||'')}</td>
          <td>${esc(r.nro_factura||'')}</td>
          <td class="right">${fmt(r.total_nota||0)}</td>
          <td>${pill}</td>
          <td class="actions">
            <button class="btn" onclick="verDetalle(${r.id_nota_remision})">Ver</button>
            <button class="btn" onclick="descargarPDF(${r.id_nota_remision})">PDF</button>
            <button class="btn" ${r.estado==='Anulada'?'disabled':''} onclick="anular(${r.id_nota_remision})">Anular</button>
          </td>
        `;
        tb.appendChild(tr);
      });
    }

    async function verDetalle(id){
      try{
        const r = await fetch(`${RUTAS.detalle}?id_nota_remision=${id}`);
        const j = await r.json();
        if(!j.ok) throw new Error(j.error||'Error');

        $('#m_titulo').textContent = `Nota #${id}`;
        const c = j.cab;
        $('#m_cab').textContent =
          `Fecha ${c.fecha_remision} | Estado ${c.estado} | Prov: ${c.proveedor} | Suc: ${c.sucursal} | Fact: ${c.nro_factura}` +
          (c.nro_remision_prov ? ` | Remisión Prov: ${c.nro_remision_prov}` : '');
        const tb = $('#m_det'); tb.innerHTML = '';
        (j.det||[]).forEach(d=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${d.id_factura_det}</td>
            <td>${d.id_producto}</td>
            <td>${esc(d.producto)}</td>
            <td class="right">${fmt(d.cantidad)}</td>
          `;
          tb.appendChild(tr);
        });
        openModal();
      }catch(e){
        console.error(e);
        showToast('Error cargando detalle','is-error');
      }
    }

    function descargarPDF(id){
      if (!RUTAS.pdf){ showToast('PDF no implementado','is-error'); return; }
      window.open(`${RUTAS.pdf}?id_nota_remision=${id}`, '_blank');
    }

    async function anular(id){
      if(!confirm(`¿Anular la Nota de Remisión #${id}?`)) return;
      const motivo = prompt('Motivo de anulación (opcional):','');
      const fd = new FormData();
      fd.append('id_nota_remision', id);
      if(motivo) fd.append('motivo', motivo);

      try{
        const r = await fetch(RUTAS.anular, {method:'POST', body: fd});
        const j = await r.json();
        if(!j.ok) throw new Error(j.error||'Error');
        showToast('Nota anulada','ok');
        buscar(false);
      }catch(e){
        console.error(e);
        showToast('No se pudo anular','is-error');
      }
    }

    function openModal(){ const m=$('#modal'); m.style.display='flex'; m.setAttribute('aria-hidden','false'); }
    function closeModal(){ const m=$('#modal'); m.style.display='none'; m.setAttribute('aria-hidden','true'); }

    // Toast helpers (usa tu CSS)
    function showToast(msg, type='ok', ms=3000){
      const t = $('#toast');
      const cssType = (type==='error'||type==='is-error') ? 'is-error' : (type||'ok');
      t.textContent = msg;
      t.className = 'toast ' + cssType;
      void t.offsetWidth;
      t.classList.add('show');
      clearTimeout(showToast._to);
      showToast._to = setTimeout(()=> hideToast(), ms);
    }
    function hideToast(){ $('#toast').classList.remove('show'); }

    function fmt(n){ return Number(n||0).toLocaleString('es-PY',{minimumFractionDigits:2, maximumFractionDigits:2}); }
    function esc(s){ return String(s||'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }
  </script>
  <script src="/../TALLER DE ANALISIS Y PROGRAMACIÓN I//proyecto sistema sabanas//menu//navbar.js"></script>
</body>
</html>
